{% extends "layout.html" %}
{% block content %}
<h1 style="text-align: center;">Create Your Deck</h1>

<!-- Deck Slots -->
<div class="deck-container">
    <div class="deck-slot" id="slot1" onclick="replaceCardInSlot(1)"></div>
    <div class="deck-slot" id="slot2" onclick="replaceCardInSlot(2)"></div>
    <div class="deck-slot" id="slot3" onclick="replaceCardInSlot(3)"></div>
    <div class="deck-slot" id="slot4" onclick="replaceCardInSlot(4)"></div>
    <div class="deck-slot" id="slot5" onclick="replaceCardInSlot(5)"></div>
    <div class="deck-slot" id="slot6" onclick="replaceCardInSlot(6)"></div>
    <div class="deck-slot" id="slot7" onclick="replaceCardInSlot(7)"></div>
    <div class="deck-slot" id="slot8" onclick="replaceCardInSlot(8)"></div>
</div>

<!-- Cancel Shaking Button -->
<button id="cancelShake" onclick="cancelShake()">Cancel Shake</button>

<!-- Shake Overlay -->
<div class="shake-overlay"></div>

<!-- Card Grid -->
<div class="card-grid-container" id="cardGrid">
    {% for card in cards %}
        {% set rarity_class = '' %}
        {% if card.rarity_type.type == 'Common' %}
            {% set rarity_class = 'common' %}
        {% elif card.rarity_type.type == 'Rare' %}
            {% set rarity_class = 'rare' %}
        {% elif card.rarity_type.type == 'Epic' %}
            {% set rarity_class = 'epic' %}
        {% elif card.rarity_type.type == 'Legendary' %}
            {% set rarity_class = 'legendary' %}
        {% endif %}
        <div class="card-item" id="card-{{ card.id }}" onclick="selectCard('{{ card.id }}', '{{ url_for('static', filename=card.image) }}')">
            <div class="image-container {{ rarity_class }}">
                <img src="{{ url_for('static', filename=card.image) }}" alt="{{ card.name }}" width="90" height="100">
                <div class="card-name">{{ card.name }}</div>
            </div>
        </div>
    {% endfor %}
</div>
<button type="button" onclick="submitDeck()">Add Deck</button>
<script>
    let deck = [];
    let selectedCardId = null;
    let replacedCard = null;

    // Select a card from the grid
    function selectCard(cardId, imagePath) {
        if (deck.length < 8) {
            addCardToDeck(cardId, imagePath);
            hideCardFromGrid(cardId);
        } else {
            selectedCardId = cardId; // Card selected for replacement
            hideNonDeckCards(); // Hide all non-deck cards
            shakeDeckContinuously();
        }
    }

    // Add card to the first empty deck slot
    function addCardToDeck(cardId, imagePath) {
        for (let i = 1; i <= 8; i++) {
            let slot = document.getElementById('slot' + i);
            if (!slot.classList.contains('filled')) {
                slot.classList.add('filled');
                slot.style.backgroundImage = 'url(' + imagePath + ')';
                slot.dataset.cardId = cardId;
                deck.push({ id: cardId, imagePath: imagePath });
                hideCardFromGrid(cardId);
                break;
            }
        }
    }

    // Hide card from grid when it's added to the deck
    function hideCardFromGrid(cardId) {
        let cardElement = document.getElementById('card-' + cardId);
        if (cardElement) {
            cardElement.style.display = 'none';
        }
    }

    // Show a card in the grid when it's removed from the deck
    function showCardInGrid(cardId, imagePath) {
        let cardElement = document.getElementById('card-' + cardId);
        if (cardElement) {
            cardElement.style.display = 'block';
        }
    }

    // Hide all non-deck cards except the selected one
    function hideNonDeckCards() {
        let cardElements = document.querySelectorAll('.card-item');
        cardElements.forEach(card => {
            let cardId = card.getAttribute('id').split('-')[1];
            if (!deck.some(d => d.id === cardId) && cardId !== selectedCardId) {
                card.style.display = 'none';
            }
        });
    }

    // Shake the deck slots to indicate replacement
    function shakeDeckContinuously() {
        document.querySelector('#cancelShake').style.display = 'block';
        document.querySelector('.shake-overlay').style.display = 'block';
        for (let i = 1; i <= 8; i++) {
            let slot = document.getElementById('slot' + i);
            if (slot.classList.contains('filled')) {
                slot.classList.add('continuous-shake');
            }
        }
    }

    // Replace the card in a slot with the selected one
    function replaceCardInSlot(slotIndex) {
        let slot = document.getElementById('slot' + slotIndex);
        if (slot.classList.contains('filled') && selectedCardId) {
            let selectedCard = { id: selectedCardId, imagePath: document.querySelector('#card-' + selectedCardId + ' img').src };

            // Remove the replaced card
            if (replacedCard) {
                showCardInGrid(replacedCard.id, replacedCard.imagePath);
            }

            replacedCard = deck.find(d => d.id === slot.dataset.cardId); // Card being replaced
            deck = deck.filter(d => d.id !== slot.dataset.cardId); // Remove old card from deck
            deck.push(selectedCard); // Add new card to the deck

            slot.dataset.cardId = selectedCard.id;
            slot.style.backgroundImage = 'url(' + selectedCard.imagePath + ')';

            stopShakingDeck();
            hideNonDeckCards();
            selectedCardId = null;
        }
    }

    // Stop shaking animation and show all cards
    function stopShakingDeck() {
        document.querySelector('#cancelShake').style.display = 'none';
        document.querySelector('.shake-overlay').style.display = 'none';
        for (let i = 1; i <= 8; i++) {
            let slot = document.getElementById('slot' + i);
            slot.classList.remove('continuous-shake');
        }
    }

    // Cancel replacement and reset card selections
    function cancelShake() {
        stopShakingDeck();
        selectedCardId = null;
        replacedCard = null;
        showAllCards();
    }

    // Show all available cards in the grid again
    function showAllCards() {
        let cardElements = document.querySelectorAll('.card-item');
        cardElements.forEach(card => {
            card.style.display = 'block';
        });
    }
    function submitDeck() {
        const formData = new FormData();

        deck.forEach((card, index) => {
            if (card) {
                formData.append('card' + (index + 1) + '_id', card.id);
            }
        });

        fetch('/add_deck', {
            method: 'POST',
            body: formData
        }).then(response => {
            if (response.ok) {
                window.location.href = '/deck';  // Redirect to deck page
            } else {
                alert('Error adding deck');
            }
        });
    }
</script>
{% endblock %}
